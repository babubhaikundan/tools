<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BabuBhaiKundan Image Tool - Pro Image Editor</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    
    <style>
        :root {
            --bg-dark: #1a1a1a; --bg-light: #242424; --primary-accent: #00e6b8; --secondary-accent: #ffc400;
            --text-primary: #f0f0f0; --text-secondary: #a0a0a0; --border-color: #3a3a3a; --success-color: #28a745;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-primary);
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 1rem;
        }
        .main-container { width: 100%; max-width: 900px; background: var(--bg-light); border-radius: 16px; border: 1px solid var(--border-color); padding: 2rem; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5); }
        .header { text-align: center; margin-bottom: 2rem; }
        .header h1 { font-size: 2.2rem; font-weight: 700; background: linear-gradient(90deg, var(--primary-accent), var(--secondary-accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header p { color: var(--text-secondary); margin-top: 0.5rem; }
        #files { display: none; }
        .upload-area { border: 2px dashed var(--border-color); border-radius: 12px; padding: 1.5rem; min-height: 200px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .upload-area.dragover { border-color: var(--primary-accent); background: #2f2f2f; }
        #upload-prompt p { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 1rem; }
        .btn-select { background: var(--primary-accent); color: var(--bg-dark); padding: 0.7rem 1.5rem; border-radius: 8px; font-weight: 600; display: inline-block; }
        #image-preview-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .preview-card { background: #2f2f2f; border-radius: 10px; border: 1px solid var(--border-color); overflow: hidden; position: relative; }
        .preview-card .image-container { height: 150px; }
        .preview-card img { width: 100%; height: 100%; object-fit: cover; }
        .preview-card .info { padding: 0.8rem; font-size: 0.8rem; }
        .preview-card .info p { margin: 4px 0; color: var(--text-secondary); }
        .preview-card .info strong { color: var(--text-primary); word-break: break-all; }
        .preview-card .actions { display: flex; gap: 5px; padding: 0.5rem; background: #3a3a3a; }
        .preview-card .actions button { flex: 1; background: #4a4a4a; color: var(--text-primary); border: none; padding: 6px; border-radius: 6px; cursor: pointer; }
        .preview-card .actions button:hover { background: var(--primary-accent); color: var(--bg-dark); }
        .preview-card .close-btn { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; line-height: 22px; text-align: center; font-size: 14px; }
        .options-panel { margin-top: 2rem; display: flex; justify-content: center; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .options-panel input[type="number"] { width: 100px; padding: 0.7rem; background: #2f2f2f; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 1rem; text-align: center; }
        .btn-compress { background: linear-gradient(90deg, var(--primary-accent), var(--secondary-accent)); color: var(--bg-dark); border: none; padding: 0.8rem 2rem; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background-color: #2a2a2a; margin: 5% auto; padding: 1.5rem; border: 1px solid var(--border-color); width: 90%; max-width: 600px; border-radius: 12px; }
        .modal-header { padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; }
        .modal-body { padding: 1rem 0; }
        .modal-footer { padding-top: 1rem; border-top: 1px solid var(--border-color); margin-top: 1rem; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-footer button { padding: 0.6rem 1.2rem; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .modal-btn-primary { background: var(--primary-accent); color: var(--bg-dark); }
        .modal-btn-secondary { background: #4a4a4a; color: var(--text-primary); }
        #crop-image-container { max-height: 400px; }
        #resize-dimensions { display: flex; align-items: center; justify-content: center; }
        .resize-input-group { text-align: right; }
        .resize-input-group label { display: block; margin-bottom: 1rem; }
        .resize-input-group input { width: 120px; margin-left: 10px; }
        #aspect-lock-btn { background: none; border: none; cursor: pointer; padding: 1rem; margin: 0 1rem; }
        #aspect-lock-btn svg { width: 24px; height: 24px; fill: var(--text-secondary); transition: fill 0.2s; }
        #aspect-lock-btn.locked svg { fill: var(--primary-accent); }
        #aspect-lock-btn:hover svg { fill: white; }
        .unit-selectors { display: flex; gap: 10px; margin-bottom: 1rem; }
        .unit-selector { background: #4a4a4a; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        .unit-selector.active { background: var(--primary-accent); color: var(--bg-dark); font-weight: 600; }
        #dpi-section { margin-bottom: 1rem; }
        #results-container { margin-top: 2rem; }
        .result-card { background: #2f2f2f; border: 1px solid var(--border-color); border-radius: 10px; padding: 1rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .download-btn { background: var(--success-color); color: white; text-decoration: none; padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; }
        
        .developer-branding {
            display: flex;
            justify-content: center;
            margin-top: 2rem;
        }
        
        @media (max-width: 600px) {
            body { padding: 0.5rem; } .main-container { padding: 1rem; } 
            .header h1 { font-size: 1.5rem; } /* Adjusted for single line title */
            #image-preview-container { grid-template-columns: 1fr; } 
            .options-panel { flex-direction: column; gap: 0.8rem; }
            .modal-content { margin: 10% auto; } 
            .result-card { flex-direction: column; align-items: flex-start; gap: 10px; }
            #resize-dimensions { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <header class="header"><h1>BabuBhaiKundan Image Tool</h1><p>Compress, Crop, and Resize images with precision.</p></header>
        <main>
            <input accept="image/*" id="files" multiple type="file">
            <div class="upload-area" id="upload-area">
                <div id="image-preview-container"></div>
                <div id="upload-prompt"><p>Drag & Drop Images or</p><b class="btn-select">Select Files</b></div>
            </div>
            <div class="options-panel">
                <label for="kbid" style="font-weight: 600;">Target Size:</label>
                <input id="kbid" type="number" value="100"><span>KB</span>
                <button class="btn-compress" id="reduce-size-btn">Compress Images</button>
            </div>
            <div id="results-container"></div>
        </main>
    </div>

    <!-- Developer Branding Footer -->
    <footer class="developer-branding">
        <a href="https://t.me/kundan_yadav_bot" target="_blank" style="display: flex;align-items: center;gap: 6px;background: #1a1a1a;padding: 6px 12px;border-radius: 12px;text-decoration: none;box-shadow: 0 4px 10px rgba(0,0,0,0.3);transition: all 0.3s ease;white-space: nowrap;">
            <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram" style="width: 18px;height: 18px;">
            <span style="color: #00ffc8;font-weight: bold;font-size: 15px;">DeveloperüíÄ:-</span>
            <span style="display: flex;align-items: center;gap: 5px;color: #FFD700;;font-size: 15px;font-weight: bold;">
                ùïÇùï¶ùïüùïïùïíùïü ùïêùïíùïïùïíùïß
                <img src="https://s.tfrbot.com/h/gL5VTi" alt="ùïÇùï¶ùïüùïïùïíùïü ùïêùïíùïïùïíùïß" style="width: 20px;height: 20px;border-radius: 50%;object-fit: cover;">
            </span>
        </a>
    </footer>

    <!-- All Modals (Crop/Resize) -->
    <div id="crop-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Crop Image</h2></div>
            <div class="modal-body"><div id="crop-image-container"><img id="image-to-crop"></div></div>
            <div class="modal-footer">
                <button class="modal-btn-secondary" onclick="document.getElementById('crop-modal').style.display='none'">Cancel</button>
                <button class="modal-btn-primary" id="crop-save-btn">Crop & Save</button>
            </div>
        </div>
    </div>
    
    <div id="resize-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Resize Image</h2></div>
            <div class="modal-body">
                <div class="unit-selectors">
                    <span class="unit-selector active" data-unit="PX">Pixels</span>
                    <span class="unit-selector" data-unit="CM">CM</span>
                    <span class="unit-selector" data-unit="MM">MM</span>
                </div>
                <div id="dpi-section" style="display: none;">
                    <label>DPI (Dots Per Inch): <input type="number" id="resize-dpi" value="300"></label>
                </div>
                <div id="resize-dimensions">
                    <div class="resize-input-group">
                        <label>Width: <input type="number" id="resize-width"> <span class="unit-label">PX</span></label>
                    </div>
                    <button id="aspect-lock-btn" class="locked">
                        <svg class="icon-lock" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"></path></svg>
                        <svg class="icon-unlock" style="display: none;" viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h2c0-1.65 1.35-3 3-3s3 1.35 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"></path></svg>
                    </button>
                    <div class="resize-input-group">
                        <label>Height: <input type="number" id="resize-height"> <span class="unit-label">PX</span></label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn-secondary" onclick="document.getElementById('resize-modal').style.display='none'">Cancel</button>
                <button class="modal-btn-primary" id="resize-save-btn">Resize & Save</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script>
        // --- COMPLETE JAVASCRIPT LOGIC ---
        
        const fileInput = document.getElementById('files');
        const uploadArea = document.getElementById('upload-area');
        const uploadPrompt = document.getElementById('upload-prompt');
        const previewContainer = document.getElementById('image-preview-container');
        const reduceBtn = document.getElementById('reduce-size-btn');
        let cropper;
        let currentEditingCard = null;

        const resizeModal = document.getElementById('resize-modal');
        const aspectLockButton = document.getElementById('aspect-lock-btn');
        const unitSelectors = resizeModal.querySelectorAll('.unit-selector');
        const dpiSection = document.getElementById('dpi-section');
        const resizeDpiInput = document.getElementById('resize-dpi');
        const resizeWidthInput = document.getElementById('resize-width');
        const resizeHeightInput = document.getElementById('resize-height');
        const unitLabels = resizeModal.querySelectorAll('.unit-label');
        let currentUnit = 'PX';
        let aspectRatio = 1;
        let isAspectRatioLocked = true;

        uploadArea.addEventListener('click', (e) => { if (e.target.id === 'upload-area' || e.target.closest('#upload-prompt')) fileInput.click(); });
        fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files));
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFileSelect(e.dataTransfer.files); });

        function handleFileSelect(files) {
            if (files.length > 0) {
                uploadPrompt.style.display = 'none';
                for (const file of files) { if (file.type.startsWith('image/')) createPreviewCard(file); }
            }
        }

        function createPreviewCard(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const card = document.createElement('div');
                    card.className = 'preview-card';
                    card.dataset.fileName = file.name;
                    card.innerHTML = `<button class="close-btn">&times;</button><div class="image-container"><img src="${e.target.result}" data-original-width="${img.width}" data-original-height="${img.height}"></div><div class="info"><p><strong>${file.name.substring(0, 15)}...</strong></p><p>Size: ${(file.size / 1024).toFixed(1)} KB</p><p class="dimensions">Dims: ${img.width}x${img.height} PX</p></div><div class="actions"><button class="resize-btn">Resize</button><button class="crop-btn">Crop</button></div>`;
                    previewContainer.appendChild(card);
                    card.querySelector('.close-btn').addEventListener('click', () => { card.remove(); if (previewContainer.children.length === 0) uploadPrompt.style.display = 'block'; });
                    card.querySelector('.resize-btn').addEventListener('click', () => openResizeModal(card));
                    card.querySelector('.crop-btn').addEventListener('click', () => openCropModal(card));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function openResizeModal(card) {
            currentEditingCard = card;
            const img = card.querySelector('img');
            aspectRatio = img.dataset.originalWidth / img.dataset.originalHeight;
            isAspectRatioLocked = true;
            updateLockIcon();
            switchUnit('PX', false);
            unitSelectors.forEach(s => s.classList.remove('active'));
            resizeModal.querySelector('[data-unit="PX"]').classList.add('active');
            resizeWidthInput.value = img.dataset.originalWidth;
            resizeHeightInput.value = img.dataset.originalHeight;
            resizeModal.style.display = 'block';
        }

        aspectLockButton.addEventListener('click', () => {
            isAspectRatioLocked = !isAspectRatioLocked;
            updateLockIcon();
            if (isAspectRatioLocked) {
                const currentWidth = parseFloat(resizeWidthInput.value);
                const currentHeight = parseFloat(resizeHeightInput.value);
                if (currentWidth && currentHeight) aspectRatio = currentWidth / currentHeight;
            }
        });

        function updateLockIcon() {
            aspectLockButton.classList.toggle('locked', isAspectRatioLocked);
            aspectLockButton.querySelector('.icon-lock').style.display = isAspectRatioLocked ? 'block' : 'none';
            aspectLockButton.querySelector('.icon-unlock').style.display = isAspectRatioLocked ? 'none' : 'block';
        }

        unitSelectors.forEach(selector => { selector.addEventListener('click', () => switchUnit(selector.dataset.unit, true)); });

        function switchUnit(newUnit, convertValues) {
            if (currentUnit === newUnit) return;
            const oldUnit = currentUnit;
            currentUnit = newUnit;
            unitSelectors.forEach(s => s.classList.toggle('active', s.dataset.unit === newUnit));
            unitLabels.forEach(l => l.textContent = newUnit);
            dpiSection.style.display = newUnit === 'PX' ? 'none' : 'block';
            if (!convertValues) return;
            const dpi = parseFloat(resizeDpiInput.value) || 300;
            let currentWidthPx = convertToPx(parseFloat(resizeWidthInput.value), oldUnit, dpi);
            let currentHeightPx = convertToPx(parseFloat(resizeHeightInput.value), oldUnit, dpi);
            resizeWidthInput.value = convertFromPx(currentWidthPx, newUnit, dpi).toFixed(2);
            resizeHeightInput.value = convertFromPx(currentHeightPx, newUnit, dpi).toFixed(2);
        }

        const CM_PER_INCH = 2.54; const MM_PER_INCH = 25.4;
        function convertToPx(value, unit, dpi) { if (unit === 'PX') return value; if (unit === 'CM') return (value / CM_PER_INCH) * dpi; if (unit === 'MM') return (value / MM_PER_INCH) * dpi; return 0; }
        function convertFromPx(px, unit, dpi) { if (unit === 'PX') return px; if (unit === 'CM') return (px / dpi) * CM_PER_INCH; if (unit === 'MM') return (px / dpi) * MM_PER_INCH; return 0; }

        resizeWidthInput.addEventListener('input', () => { if (isAspectRatioLocked && document.activeElement === resizeWidthInput) { const newWidth = parseFloat(resizeWidthInput.value); if(!isNaN(newWidth)) resizeHeightInput.value = (newWidth / aspectRatio).toFixed(2); } });
        resizeHeightInput.addEventListener('input', () => { if (isAspectRatioLocked && document.activeElement === resizeHeightInput) { const newHeight = parseFloat(resizeHeightInput.value); if(!isNaN(newHeight)) resizeWidthInput.value = (newHeight * aspectRatio).toFixed(2); } });

        document.getElementById('resize-save-btn').addEventListener('click', () => {
            if (!currentEditingCard) return;
            const dpi = parseFloat(resizeDpiInput.value) || 300;
            const finalWidthPx = Math.round(convertToPx(parseFloat(resizeWidthInput.value), currentUnit, dpi));
            const finalHeightPx = Math.round(convertToPx(parseFloat(resizeHeightInput.value), currentUnit, dpi));
            const imgElement = currentEditingCard.querySelector('img');
            const originalImage = new Image();
            originalImage.onload = () => {
                const canvas = document.createElement('canvas'); canvas.width = finalWidthPx; canvas.height = finalHeightPx;
                canvas.getContext('2d').drawImage(originalImage, 0, 0, finalWidthPx, finalHeightPx);
                imgElement.src = canvas.toDataURL('image/jpeg');
                imgElement.dataset.originalWidth = finalWidthPx; imgElement.dataset.originalHeight = finalHeightPx;
                currentEditingCard.querySelector('.dimensions').textContent = `Dims: ${finalWidthPx}x${finalHeightPx} PX`;
                resizeModal.style.display = 'none';
            };
            originalImage.src = imgElement.src;
        });

        function openCropModal(card) { currentEditingCard = card; const modal = document.getElementById('crop-modal'); const imageToCrop = document.getElementById('image-to-crop'); imageToCrop.src = card.querySelector('img').src; modal.style.display = 'block'; if (cropper) cropper.destroy(); cropper = new Cropper(imageToCrop, { viewMode: 1, background: false }); }
        document.getElementById('crop-save-btn').addEventListener('click', () => { if (!cropper || !currentEditingCard) return; const croppedCanvas = cropper.getCroppedCanvas(); const newImageDataUrl = croppedCanvas.toDataURL('image/jpeg'); const imgElement = currentEditingCard.querySelector('img'); imgElement.src = newImageDataUrl; imgElement.dataset.originalWidth = croppedCanvas.width; imgElement.dataset.originalHeight = croppedCanvas.height; currentEditingCard.querySelector('.dimensions').textContent = `Dims: ${croppedCanvas.width}x${croppedCanvas.height} PX`; document.getElementById('crop-modal').style.display = 'none'; });
        
        reduceBtn.addEventListener('click', async () => { 
            const targetSizeKB = parseInt(document.getElementById('kbid').value); 
            const previewCards = document.querySelectorAll('.preview-card'); 
            if (previewCards.length === 0) { alert('Please select an image first.'); return; } 
            document.getElementById('results-container').innerHTML = ''; 
            for (const card of previewCards) { 
                const blob = await (await fetch(card.querySelector('img').src)).blob(); 
                const compressedResult = await compressBlob(blob, targetSizeKB); 
                displayResult(compressedResult, card.dataset.fileName); 
            } 
        });
        
        async function compressBlob(blob, targetSizeKB) { 
            const targetSizeBytes = targetSizeKB * 1024; 
            const originalSizeKB = (blob.size / 1024).toFixed(1); 
            let imageBitmap = await createImageBitmap(blob); 
            const canvas = document.createElement('canvas'); 
            const ctx = canvas.getContext('2d'); 
            const sizeRatio = blob.size / targetSizeBytes; 
            if (sizeRatio > 2) { 
                const resizeFactor = Math.sqrt(sizeRatio) * 0.9; 
                const newWidth = Math.floor(imageBitmap.width / resizeFactor); 
                const newHeight = Math.floor(imageBitmap.height / resizeFactor); 
                const tempCanvas = document.createElement('canvas'); 
                tempCanvas.width = newWidth; tempCanvas.height = newHeight; 
                tempCanvas.getContext('2d').drawImage(imageBitmap, 0, 0, newWidth, newHeight); 
                imageBitmap = await createImageBitmap(tempCanvas); 
            } 
            canvas.width = imageBitmap.width; canvas.height = imageBitmap.height; 
            ctx.drawImage(imageBitmap, 0, 0); 
            let minQuality = 0, maxQuality = 1, bestBlob = null; 
            for (let i = 0; i < 12; i++) { 
                const quality = (minQuality + maxQuality) / 2; 
                const newBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', quality)); 
                if (newBlob.size <= targetSizeBytes) { bestBlob = newBlob; minQuality = quality; } 
                else { maxQuality = quality; } 
            } 
            if (!bestBlob) { bestBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.1)); } 
            return { originalSizeKB, newSizeKB: (bestBlob.size / 1024).toFixed(1), downloadUrl: URL.createObjectURL(bestBlob) }; 
        }
        
        function displayResult(result, fileName) { 
            const resultsContainer = document.getElementById('results-container'); 
            const card = document.createElement('div'); 
            card.className = 'result-card'; 
            card.innerHTML = `<div><strong>${fileName}</strong><p style="color: var(--text-secondary); font-size: 0.9rem;">${result.originalSizeKB} KB &rarr; <strong style="color: var(--primary-accent);">${result.newSizeKB} KB</strong></p></div><a href="${result.downloadUrl}" download="${fileName}" class="download-btn">Download</a>`; 
            resultsContainer.appendChild(card); 
        }
    </script>
</body>
</html>